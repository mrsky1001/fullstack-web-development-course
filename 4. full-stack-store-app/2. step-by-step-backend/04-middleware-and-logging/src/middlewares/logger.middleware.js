/**
 * ====================================================================
 * MIDDLEWARE: Request Logger (Логирование запросов)
 * ====================================================================
 * 
 * Этот middleware записывает информацию о каждом входящем запросе.
 * 
 * Что такое Middleware?
 * ---------------------
 * Middleware — это функция с сигнатурой (req, res, next).
 * Она получает:
 *   - req: объект запроса (с данными от клиента)
 *   - res: объект ответа (для отправки данных клиенту)
 *   - next: функция для передачи управления следующему middleware
 * 
 * Если middleware не вызывает next() и не отправляет ответ,
 * запрос "застрянет" — клиент не получит ответа!
 * 
 * ====================================================================
 */

/**
 * Middleware для логирования HTTP запросов
 * 
 * @param {Object} req - Объект запроса
 * @param {Object} res - Объект ответа
 * @param {Function} next - Функция для передачи управления дальше
 */
const requestLogger = (req, res, next) => {
    // ШАГ 1: Фиксируем время начала обработки запроса
    // --------------------------------------------------------------------
    const startTime = Date.now();

    // ШАГ 2: Формируем информацию о запросе
    // --------------------------------------------------------------------
    const method = req.method;           // HTTP метод (GET, POST, PUT, DELETE)
    const url = req.originalUrl || req.url; // Полный URL с query параметрами
    const timestamp = new Date().toLocaleTimeString('ru-RU');

    // ШАГ 3: Выводим информацию о входящем запросе
    // --------------------------------------------------------------------
    console.log(`[${timestamp}] ➡️  ${method} ${url}`);

    // ШАГ 4: "Подслушиваем" окончание ответа
    // --------------------------------------------------------------------
    // Событие 'finish' срабатывает, когда сервер закончил отправку ответа.
    // Это позволяет узнать код статуса и время обработки.

    res.on('finish', () => {
        const duration = Date.now() - startTime; // Время обработки в мс
        const statusCode = res.statusCode;       // HTTP код ответа

        // Выбираем эмодзи в зависимости от статуса
        let statusIcon;
        if (statusCode >= 200 && statusCode < 300) {
            statusIcon = '✅'; // Успех (2xx)
        } else if (statusCode >= 300 && statusCode < 400) {
            statusIcon = '↪️'; // Редирект (3xx)
        } else if (statusCode >= 400 && statusCode < 500) {
            statusIcon = '⚠️'; // Ошибка клиента (4xx)
        } else {
            statusIcon = '❌'; // Ошибка сервера (5xx)
        }

        console.log(`[${timestamp}] ${statusIcon} ${method} ${url} → ${statusCode} (${duration}ms)`);
    });

    // ШАГ 5: Передаём управление следующему middleware
    // --------------------------------------------------------------------
    // БЕЗ ВЫЗОВА next() запрос "застрянет"!

    next();
};

module.exports = requestLogger;
