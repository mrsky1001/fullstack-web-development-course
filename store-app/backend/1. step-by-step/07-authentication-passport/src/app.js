/**
 * ====================================================================
 * –£–†–û–ö 7: –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø - –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (app.js)
 * ====================================================================
 * 
 * –í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –¥–æ–±–∞–≤–ª—è–µ–º:
 * 1. –°–µ—Å—Å–∏–∏ (express-session) ‚Äî –¥–ª—è "–∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * 2. Passport.js ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
 * 3. bcrypt ‚Äî —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
 * 
 * –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
 * 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email + password
 * 2. –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ö–µ—à–∏)
 * 3. –ï—Å–ª–∏ –≤–µ—Ä–Ω–æ ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–µ—Å—Å–∏—è (cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É)
 * 4. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
 * 5. –°–µ—Ä–≤–µ—Ä –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Å—Å–∏–∏
 * 
 * ====================================================================
 */

const express = require('express');
const session = require('express-session');
const passport = require('passport');
const LocalStrategy = require('passport-local');

const app = express();

// Middleware
const requestLogger = require('./middlewares/logger.middleware');

// –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä—ã
const authRouter = require('./routes/auth.router');
const productRouter = require('./routes/product.router');

// –°–µ—Ä–≤–∏—Å—ã
const userService = require('./services/user.service');

// ====================================================================
// MIDDLEWARE: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥
// ====================================================================

app.use(requestLogger);
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ====================================================================
// –°–ï–°–°–ò–ò (express-session)
// ====================================================================
// 
// –°–µ—Å—Å–∏—è ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± "–∑–∞–ø–æ–º–Ω–∏—Ç—å" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.
// HTTP –ø—Ä–æ—Ç–æ–∫–æ–ª —Å–∞–º –ø–æ —Å–µ–±–µ "–±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è" (stateless).
// –°–µ—Å—Å–∏–∏ —Ä–µ—à–∞—é—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É —á–µ—Ä–µ–∑ cookies.
// 
// –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie —Å ID —Å–µ—Å—Å–∏–∏.
// –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —ç—Ç–æ—Ç cookie,
// –∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞—Ö–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (–≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –ë–î).
// 
// ====================================================================

app.use(session({
    // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ cookie (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ª—É—á–∞–π–Ω—ã–º!)
    secret: process.env.SESSION_SECRET || 'dev-secret-change-in-production',

    // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–µ—Å—Å–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –º–µ–Ω—è–ª–∞—Å—å (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    resave: false,

    // –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –¥–ª—è –≥–æ—Å—Ç–µ–π (–ø–æ–∫–∞ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑—É—é—Ç—Å—è)
    saveUninitialized: false,

    // –ò–º—è cookie
    name: 'sessionId',

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ cookie
    cookie: {
        maxAge: 1000 * 60 * 60 * 24, // 24 —á–∞—Å–∞
        httpOnly: process.env.NODE_ENV === 'production',
        secure: process.env.NODE_ENV === 'production',
        sameSite: process.env.NODE_ENV === 'production' ? 'lax' : false
    }
}));

// ====================================================================
// PASSPORT.JS - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
// ====================================================================
// 
// Passport.js ‚Äî –º–æ–¥—É–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
// –û–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ "—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏" (—Å–ø–æ—Å–æ–±—ã –≤—Ö–æ–¥–∞):
// - Local (–ª–æ–≥–∏–Ω + –ø–∞—Ä–æ–ª—å)
// - Google OAuth
// - Facebook
// - JWT —Ç–æ–∫–µ–Ω—ã
// –∏ –±–æ–ª–µ–µ 500 –¥—Ä—É–≥–∏—Ö!
// 
// ====================================================================

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Passport
app.use(passport.initialize());

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Passport –∫ —Å–µ—Å—Å–∏—è–º
// –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
app.use(passport.session());

// ====================================================================
// PASSPORT.JS - –°—Ç—Ä–∞—Ç–µ–≥–∏—è Local
// ====================================================================
// 
// LocalStrategy –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.
// –ú—ã —É–∫–∞–∑—ã–≤–∞–µ–º:
// 1. –ö–∞–∫–∏–µ –ø–æ–ª—è –∏–∑ req.body –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (usernameField, passwordField)
// 2. –§—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ (verify callback)
// 
// ====================================================================

passport.use(new LocalStrategy(
    // –û–ø—Ü–∏–∏: –∫–∞–∫–∏–µ –ø–æ–ª—è –≤ body —Å–æ–¥–µ—Ä–∂–∞—Ç –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å
    {
        usernameField: 'email',     // –ò—Å–ø–æ–ª—å–∑—É–µ–º email –∫–∞–∫ –ª–æ–≥–∏–Ω
        passwordField: 'password'   // –ü–æ–ª–µ —Å –ø–∞—Ä–æ–ª–µ–º
    },
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ passport.authenticate('local'))
    // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤ userService
    userService.verifyUser
));

// ====================================================================
// PASSPORT.JS - –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
// ====================================================================
// 
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –Ω—É–∂–Ω–æ "—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏—é.
// –¢–æ –µ—Å—Ç—å —Ä–µ—à–∏—Ç—å, –ß–¢–û —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–µ—Å—Å–∏–∏ (–æ–±—ã—á–Ω–æ —Ç–æ–ª—å–∫–æ ID –∏–ª–∏ email).
// 
// –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ –Ω—É–∂–Ω–æ "–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å" ‚Äî 
// –ø–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é –Ω–∞–π—Ç–∏ –ø–æ–ª–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
// 
// ====================================================================

// –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ß–¢–û —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–µ—Å—Å–∏—é?
// –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ email (–º–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö –≤ cookie)
passport.serializeUser((user, done) => {
    done(null, user.email);
});

// –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ö–ê–ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
// –ü–æ email –Ω–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
passport.deserializeUser(async (email, done) => {
    try {
        const user = await userService.findUser({ email });
        done(null, user);
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
        done(err);
    }
});

// ====================================================================
// –ú–ê–†–®–†–£–¢–´
// ====================================================================

app.get('/', (req, res) => {
    const user = req.user;
    res.send(`
        <h1>üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å Passport.js</h1>
        <p>–£—Ä–æ–∫ 7: –í—Ö–æ–¥, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ —Å–µ—Å—Å–∏–∏</p>
        
        <h3>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</h3>
        <pre>${user ? JSON.stringify(user, null, 2) : '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}</pre>
        
        <h3>Auth API:</h3>
        <ul>
            <li>POST /auth/register ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</li>
            <li>POST /auth/login ‚Äî –í—Ö–æ–¥</li>
            <li>POST /auth/logout ‚Äî –í—ã—Ö–æ–¥</li>
            <li>GET /auth/check ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞</li>
        </ul>
        
        <h3>Product API:</h3>
        <ul>
            <li><a href="/product/all">GET /product/all</a></li>
        </ul>
    `);
});

// Auth –º–∞—Ä—à—Ä—É—Ç—ã
app.use('/auth', authRouter);

// Product –º–∞—Ä—à—Ä—É—Ç—ã
app.use('/product', productRouter);

// 404
app.use((req, res) => {
    res.status(404).json({
        status: 'error',
        message: `–ú–∞—Ä—à—Ä—É—Ç ${req.method} ${req.url} –Ω–µ –Ω–∞–π–¥–µ–Ω`
    });
});

// Error handler
app.use((err, req, res, next) => {
    console.error('‚ùå –û—à–∏–±–∫–∞:', err.message);
    res.status(500).json({
        status: 'error',
        message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    });
});

module.exports = app;
