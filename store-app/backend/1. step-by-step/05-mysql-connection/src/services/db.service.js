/**
 * ====================================================================
 * SERVICE: Database (Сервис подключения к БД)
 * ====================================================================
 * 
 * Этот модуль отвечает за подключение к MySQL базе данных.
 * 
 * Мы используем:
 * 1. mysql2 — современный драйвер MySQL для Node.js
 * 2. Connection Pool — пул соединений (для производительности)
 * 3. Promise API — для работы с async/await
 * 
 * Что такое Connection Pool?
 * --------------------------
 * Вместо того чтобы открывать новое соединение для каждого запроса
 * (что медленно), пул держит несколько соединений открытыми и переиспользует их.
 * Это значительно ускоряет работу с БД.
 * 
 * ====================================================================
 */

const mysql = require('mysql2');

// ====================================================================
// СОЗДАНИЕ ПУЛА СОЕДИНЕНИЙ
// ====================================================================
// 
// Значения берутся из переменных окружения (process.env)
// Если переменная не задана, используется значение по умолчанию (после ||)
// 
// ВАЖНО: process.env загружается в server.js через dotenv.config()
// Этот файл импортируется ПОСЛЕ, поэтому переменные уже доступны.
// ====================================================================

const pool = mysql.createPool({
    // Максимальное количество соединений в пуле
    connectionLimit: parseInt(process.env.DB_CONNECTION_LIMIT) || 5,

    // Адрес сервера MySQL (обычно localhost для локальной разработки)
    host: process.env.DB_HOST || 'localhost',

    // Имя пользователя MySQL
    user: process.env.DB_USER || 'root',

    // Пароль MySQL (пустой по умолчанию для локальной разработки)
    password: process.env.DB_PASSWORD || '',

    // Имя базы данных
    database: process.env.DB_NAME || 'storedb',

    // Дополнительные настройки
    waitForConnections: true,    // Ждать свободное соединение
    queueLimit: 0                // Неограниченная очередь ожидания
});

// ====================================================================
// ПРОМИСИФИЦИРОВАННЫЙ ПУЛЛ
// ====================================================================
// 
// .promise() возвращает версию пула, которая работает с Promise.
// Это позволяет использовать современный синтаксис async/await
// вместо callback-функций.
// 
// Без .promise():
//   pool.execute('SELECT * FROM users', (err, results) => { ... });
// 
// С .promise():
//   const [rows] = await pool.execute('SELECT * FROM users');
// ====================================================================

const db = pool.promise();

// Проверяем подключение при старте
db.execute('SELECT 1')
    .then(() => {
        console.log('✅ Подключение к MySQL успешно установлено');
    })
    .catch((err) => {
        console.warn('⚠️ MySQL недоступен:', err.message);
        console.warn('   Будут использоваться mock-данные');
    });

module.exports = db;
