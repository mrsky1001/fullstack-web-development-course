/**
 * ====================================================================
 * –£–†–û–ö 4: MIDDLEWARE –ò –õ–û–ì–ò–†–û–í–ê–ù–ò–ï - –ü–†–ò–õ–û–ñ–ï–ù–ò–ï (app.js)
 * ====================================================================
 * 
 * Middleware (–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û) ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
 * –ú–ï–ñ–î–£ –ø–æ–ª—É—á–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞.
 * 
 * –û–Ω–∏ –æ–±—Ä–∞–∑—É—é—Ç "—Ü–µ–ø–æ—á–∫—É" –∏–ª–∏ "–∫–æ–Ω–≤–µ–π–µ—Ä" –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.
 * –ö–∞–∂–¥–∞—è middleware —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç:
 * - –ò–∑–º–µ–Ω–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã req –∏ res
 * - –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç)
 * - –ü–µ—Ä–µ–¥–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–π middleware (–≤—ã–∑–≤–∞–≤ next())
 * 
 * –ü–æ—Ä—è–¥–æ–∫ middleware –í–ê–ñ–ï–ù! –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑.
 * 
 * ====================================================================
 */

const express = require('express');
const app = express();

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ middleware
const requestLogger = require('./middlewares/logger.middleware');

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä
const productRouter = require('./routes/product.router');

// ====================================================================
// –ü–û–†–Ø–î–û–ö MIDDLEWARE - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ï–ù!
// ====================================================================
// 
// –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–æ–º –ø–æ—Ä—è–¥–∫–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º
// –æ–±—ä—è–≤–ª–µ–Ω—ã middleware –≤ –∫–æ–¥–µ:
// 
// 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∞—à middleware)
// 2. –ü–∞—Ä—Å–∏–Ω–≥ JSON (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
// 3. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)
// 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ 404 (–µ—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω)
// 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å)
// 
// ====================================================================

// –®–ê–ì 1: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
// --------------------------------------------------------------------
// –≠—Ç–æ –Ω–∞—à –ö–ê–°–¢–û–ú–ù–´–ô middleware –∏–∑ —Ñ–∞–π–ª–∞ middlewares/logger.middleware.js
// –û–Ω –≤—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤ –∫–æ–Ω—Å–æ–ª—å

app.use(requestLogger);

// –®–ê–ì 2: –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ middleware Express
// --------------------------------------------------------------------
// Express –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–µ–∑–Ω—ã—Ö middleware "–∏–∑ –∫–æ—Ä–æ–±–∫–∏"

// express.json() ‚Äî –ø–∞—Ä—Å–∏—Ç JSON —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ req.body
app.use(express.json());

// express.urlencoded() ‚Äî –ø–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ HTML —Ñ–æ—Ä–º
app.use(express.urlencoded({ extended: true }));

// –®–ê–ì 3: –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
// --------------------------------------------------------------------

app.get('/', (req, res) => {
    res.send(`
        <h1>üöÄ Middleware –∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
        <p>–£—Ä–æ–∫ 4: –ò–∑—É—á–∞–µ–º middleware –≤ Express</p>
        <p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤!</p>
        <h3>API Endpoints:</h3>
        <ul>
            <li><a href="/product/all">GET /product/all</a></li>
            <li><a href="/product/1">GET /product/:id</a></li>
        </ul>
    `);
});

// –®–ê–ì 4: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä—ã
// --------------------------------------------------------------------

app.use('/product', productRouter);

// –®–ê–ì 5: –û–±—Ä–∞–±–æ—Ç–∫–∞ 404 (Not Found)
// --------------------------------------------------------------------
// –≠—Ç–æ—Ç middleware —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –µ—Å–ª–∏ –ù–ò –û–î–ò–ù –º–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ–¥–æ—à—ë–ª
// –í–ê–ñ–ù–û: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–°–õ–ï –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤!

app.use((req, res, next) => {
    res.status(404).json({
        status: 'error',
        message: `–ú–∞—Ä—à—Ä—É—Ç ${req.method} ${req.url} –Ω–µ –Ω–∞–π–¥–µ–Ω`,
        statusCode: 404
    });
});

// –®–ê–ì 6: –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
// --------------------------------------------------------------------
// –≠—Ç–æ—Ç middleware –∏–º–µ–µ—Ç 4 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (err, req, res, next).
// Express –≤—ã–∑—ã–≤–∞–µ—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.
// –í–ê–ñ–ù–û: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–°–õ–ï–î–ù–ò–ú middleware!

app.use((err, req, res, next) => {
    console.error('‚ùå –û—à–∏–±–∫–∞:', err.message);
    console.error(err.stack);

    res.status(500).json({
        status: 'error',
        message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞',
        statusCode: 500
    });
});

module.exports = app;
