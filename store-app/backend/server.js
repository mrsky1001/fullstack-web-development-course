/**
 * –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ –°–ï–†–í–ï–†–ê (ENTRY POINT)
 * 
 * –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
 * 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (Express, CORS, Session, Passport).
 * 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö).
 * 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–æ–≤ (Routers) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
 * 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 3000.
 */

// --- 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---

// Express - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–∞ Node.js.
// –û–Ω —É–ø—Ä–æ—â–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é.
const express = require("express");
const server = express(); // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Express

// CORS (Cross-Origin Resource Sharing) - –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –±—Ä–∞—É–∑–µ—Ä—É
// –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ —Å–µ—Ä–≤–µ—Ä—É —Å –¥—Ä—É–≥–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å frontend –Ω–∞ backend).
const cors = require('cors');

// express-session - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
// –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–µ—Ä–≤–µ—Ä—É "–∑–∞–ø–æ–º–∏–Ω–∞—Ç—å" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –±–∞–∑–µ).
const session = require("express-session");

// Passport.js - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤—Ö–æ–¥–∞) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å, Google, Facebook –∏ —Ç.–¥.).
const passport = require("passport");
const LocalStrategy = require("passport-local"); // –°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤—Ö–æ–¥–∞ –ø–æ –ª–æ–≥–∏–Ω—É –∏ –ø–∞—Ä–æ–ª—é

// –ò–º–ø–æ—Ä—Ç –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–æ–≤ (Routers)
// –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä—ã –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç–µ–º–∞–º (auth, products, cart).
const authRouter = require("./routers/auth.router");
const productRouter = require("./routers/product.router");
const shoppingCartRouter = require("./routers/shopping-cart.router");

// –ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ middleware
const userService = require("./services/user.service");
const { isAuthenticated } = require("./middleware/auth.middleware");

// --- 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –î–æ—Å—Ç—É–ø) ---

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CORS –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–æ–º—É —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —ç—Ç–æ–º—É —Å–µ—Ä–≤–µ—Ä—É.
const corsOptions = {
    origin: true, // true –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã —Å –ª—é–±—ã—Ö –¥–æ–º–µ–Ω–æ–≤ (—É–¥–æ–±–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
    credentials: true, // –†–∞–∑—Ä–µ—à–∞–µ—Ç –ø–µ—Ä–µ–¥–∞—á—É cookies –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    optionsSuccessStatus: 200 // –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö (preflight) –∑–∞–ø—Ä–æ—Å–æ–≤
};

server.use(cors(corsOptions));

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
server.use((req, res, next) => {
    res.header('Access-Control-Allow-Credentials', 'true');
    res.header('Access-Control-Allow-Origin', req.headers.origin || '*');
    res.header('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');

    // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (OPTIONS), —Å—Ä–∞–∑—É –æ—Ç–≤–µ—á–∞–µ–º "OK"
    if (req.method === 'OPTIONS') {
        return res.sendStatus(200);
    }
    next(); // –ü–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É
});

// --- 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö ---

server.use(express.json()); // –ü–æ–∑–≤–æ–ª—è–µ—Ç —á–∏—Ç–∞—Ç—å JSON –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ (req.body)
server.use(express.urlencoded({ extended: true })); // –ü–æ–∑–≤–æ–ª—è–µ—Ç —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º (application/x-www-form-urlencoded)

// --- 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –°–µ—Å—Å–∏–π (Sessions) ---

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cookie —Å–µ—Å—Å–∏–∏.
// –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ –∏ –∂–∏–≤–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è.
server.use(session({
    secret: 'secret-key-educational-project', // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ cookie (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ª–æ–∂–Ω—ã–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
    resave: false, // –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–µ—Å—Å–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –º–µ–Ω—è–ª–∞—Å—å
    saveUninitialized: false, // –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—É—Å—Ç—É—é —Å–µ—Å—Å–∏—é –¥–ª—è –≥–æ—Å—Ç–µ–π
    name: 'sessionId', // –ò–º—è cookie, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç—É
    cookie: {
        maxAge: 1000 * 60 * 60 * 24, // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ cookie (24 —á–∞—Å–∞)
        httpOnly: false,             // false –ø–æ–∑–≤–æ–ª—è–µ—Ç JS –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —á–∏—Ç–∞—Ç—å cookie (–æ–±—ã—á–Ω–æ true –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
        secure: false,               // false, —Ç–∞–∫ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞ localhost (http, –∞ –Ω–µ https)
        sameSite: false              // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    },
}));

// --- 5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (Logging) ---

// –ü—Ä–æ—Å—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞.
// –ü–æ–º–æ–≥–∞–µ—Ç –≤–∏–¥–µ—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
server.use((req, res, next) => {
    console.log(`[REQUEST] ${req.method} ${req.path}`);
    next();
});

// --- 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Passport (–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è) ---

server.use(passport.initialize()); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è passport
server.use(passport.session()); // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ passport –∫ —Å–µ—Å—Å–∏—è–º

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ "Local":
// –£–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫–∏–µ –ø–æ–ª—è –≤ body –∑–∞–ø—Ä–æ—Å–∞ —Å—á–∏—Ç–∞—Ç—å –ª–æ–≥–∏–Ω–æ–º –∏ –ø–∞—Ä–æ–ª–µ–º.
// –§—É–Ω–∫—Ü–∏—è userService.verifyUser –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.
passport.use(new LocalStrategy(
    { usernameField: 'email', passwordField: 'password' },
    userService.verifyUser
));

// –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–µ—Å—Å–∏—é –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞? (—Å–æ—Ö—Ä–∞–Ω—è–µ–º email)
passport.serializeUser((user, callback) => {
    callback(null, user.email);
});

// –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ —Å–µ—Å—Å–∏–∏?
// –ë–µ—Ä–µ–º email –∏–∑ —Å–µ—Å—Å–∏–∏ –∏ –∏—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
passport.deserializeUser(async (email, callback) => {
    try {
        const foundedUser = await userService.findUser({ email });
        callback(null, foundedUser);
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Å—Å–∏–∏:', err);
        callback(err);
    }
});

// --- 7. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (Routing) ---

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –≥—Ä—É–ø–ø—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ –±–∞–∑–æ–≤—ã–º –ø—É—Ç—è–º
server.use('/auth', authRouter);          // –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (login, register...)
server.use('/product', productRouter);    // –ó–∞–ø—Ä–æ—Å—ã —Ç–æ–≤–∞—Ä–æ–≤
server.use('/shopping-cart', isAuthenticated, shoppingCartRouter); // –ö–æ—Ä–∑–∏–Ω–∞ (–¥–æ—Å—Ç—É–ø–Ω–∞ –¢–û–õ–¨–ö–û –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º)

// --- 8. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ ---

const PORT = 3000;
server.listen(PORT, () => {
    console.log(`\nüöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π!`);
    console.log(`–ê–¥—Ä–µ—Å: http://localhost:${PORT}`);
    console.log(`----------------------------------------`);
});

module.exports = server;